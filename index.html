<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Tracking System</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .header {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .login-section {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 400px;
            margin: 20px auto;
        }
        
        .form-section {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .user-info {
            background-color: #3498db;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }
        
        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #2c3e50;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: #3498db;
            outline: none;
        }
        
        button {
            background-color: #3498db;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        .logout-btn {
            background-color: #e74c3c;
        }
        
        .logout-btn:hover {
            background-color: #c0392b;
        }
        
        .qr-section {
            text-align: center;
            margin-top: 20px;
        }
        
        #qrcode {
            margin: 20px auto;
            display: none;
        }
        
        .document-list {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .document-item {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        
        .status {
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 20px;
            color: white;
            display: inline-block;
            margin-top: 10px;
        }
        
        .status.pending { background-color: #f39c12; }
        .status.processing { background-color: #3498db; }
        .status.completed { background-color: #27ae60; }
        .status.returned { background-color: #e74c3c; }
        .status.received { background-color: #8e44ad; }
        .status.forwarded { background-color: #16a085; }
        
        .hidden { display: none; }
        
        .credentials-info {
            background-color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 14px;
        }
        
        .credentials-info h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .permission-note {
            background-color: #f8f9fa;
            border-left: 4px solid #3498db;
            padding: 10px;
            margin-bottom: 20px;
        }
        
        .admin-nav {
            background-color: #34495e;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .admin-nav button {
            background-color: #3498db;
            margin: 0 5px;
        }
        
        .admin-nav button.active {
            background-color: #2c3e50;
        }
        
        .user-item {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            background-color: #f9f9f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .user-details h4 {
            margin: 0 0 5px 0;
            color: #2c3e50;
        }
        
        .user-details p {
            margin: 2px 0;
            color: #666;
            font-size: 14px;
        }
        
        .user-actions button {
            margin-left: 5px;
            padding: 8px 12px;
            font-size: 12px;
        }
        
        .delete-btn {
            background-color: #e74c3c;
        }
        
        .delete-btn:hover {
            background-color: #c0392b;
        }
        
        .edit-btn {
            background-color: #f39c12;
        }
        
        .edit-btn:hover {
            background-color: #d68910;
        }
        
        .document-type {
            background-color: #3498db;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            display: inline-block;
            margin-right: 10px;
        }
        
        .document-type.activity { background-color: #9b59b6; }
        .document-type.purchase { background-color: #e67e22; }
        .document-type.bac { background-color: #27ae60; }
        
        .qr-scanner-section {
            background-color: #e8f6f3;
            border: 2px dashed #27ae60;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .scan-input {
            background-color: #f8f9fa;
            border: 2px solid #6c757d;
            padding: 15px;
            font-family: monospace;
            font-size: 16px;
            text-align: center;
            margin: 10px 0;
        }
        
        .workflow-info {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        /* Search Box Styles */
        .search-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #17a2b8;
        }
        
        .search-box {
            width: 100%;
            padding: 12px;
            border: 2px solid #17a2b8;
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box;
        }
        
        .search-box:focus {
            border-color: #138496;
            outline: none;
            box-shadow: 0 0 5px rgba(23, 162, 184, 0.3);
        }
        
        .search-results-info {
            margin-top: 10px;
            font-size: 14px;
            color: #6c757d;
        }
        
        /* QR Code Print Styles */
        .qr-container {
            background-color: white;
            border: 2px solid #2c3e50;
            border-radius: 8px;
            padding: 20px;
            margin: 20px auto;
            max-width: 300px;
            text-align: center;
        }
        
        .qr-print-btn {
            background-color: #28a745;
            margin-top: 10px;
        }
        
        .qr-print-btn:hover {
            background-color: #218838;
        }
        
        /* Standalone QR Generator Styles */
        .qr-generator-section {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        
        .qr-result {
            margin-top: 20px;
            text-align: center;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            border: 2px solid #ddd;
        }
        
        /* Print Styles for 57mm paper */
        @media print {
            body * {
                visibility: hidden;
            }
            
            .qr-print-section, .qr-print-section * {
                visibility: visible;
            }
            
            .qr-print-section {
                position: absolute;
                left: 0;
                top: 0;
                width: 57mm;
                margin: 0;
                padding: 2mm;
                background: white;
            }
            
            .qr-print-title {
                font-size: 10pt;
                font-weight: bold;
                margin-bottom: 2mm;
                text-align: center;
            }
            
            .qr-print-canvas {
                display: block;
                margin: 2mm auto;
                width: 40mm !important;
                height: 40mm !important;
            }
            
            .qr-print-id {
                font-family: monospace;
                font-size: 8pt;
                font-weight: bold;
                text-align: center;
                margin: 2mm 0;
                word-break: break-all;
            }
            
            .qr-print-info {
                font-size: 7pt;
                text-align: center;
                margin-top: 2mm;
                line-height: 1.2;
            }
        }
        
        @page {
            size: 57mm auto;
            margin: 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîê Local Government Document Tracking System</h1>
        <p>Secure document tracking with QR code workflow</p>
    </div>

    <!-- Login Section -->
    <div id="loginSection" class="login-section">
        <h2>üîë User Login</h2>
        <form id="loginForm">
            <div class="form-group">
                <label for="username">Username:</label>
                <input type="text" id="username" required>
            </div>
            
            <div class="form-group">
                <label for="password">Password:</label>
                <input type="password" id="password" required>
            </div>
            
            <button type="submit">üö™ Login</button>
        </form>
        
        <div class="credentials-info">
            <h4>Demo Login Credentials:</h4>
            <p><strong>Mayor's Office:</strong> MYO / 123</p>
            <p><strong>Budget Office:</strong> MBO / 123</p>
            <p><strong>Accounting Office:</strong> MACO / 123</p>
            <p><strong>Municipal Admin:</strong> MADO / 123</p>
            <p><strong>Admin:</strong> admin / admin123</p>
        </div>
    </div>

    <!-- Main Application (Hidden until login) -->
    <div id="mainApp" class="hidden">
        <div class="user-info">
            <span id="welcomeMessage">Welcome!</span>
            <button class="logout-btn" onclick="logout()">üö™ Logout</button>
        </div>
        
        <div id="permissionNote" class="permission-note hidden">
            <strong>üìù Note:</strong> <span id="permissionText"></span>
        </div>
        
        <!-- Admin Navigation -->
        <div id="adminNav" class="admin-nav hidden">
            <button onclick="showSection('documents')" id="documentsBtn" class="active">üìã Documents</button>
            <button onclick="showSection('scanner')" id="scannerBtn">üì± QR Scanner</button>
            <button onclick="showSection('qrgenerator')" id="qrGeneratorBtn">üîß QR Generator</button>
            <button onclick="showSection('users')" id="usersBtn">üë• Manage Users</button>
        </div>
        
        <!-- Regular User Navigation -->
        <div id="userNav" class="admin-nav hidden">
            <button onclick="showSection('documents')" id="userDocumentsBtn" class="active">üìã Documents</button>
            <button onclick="showSection('scanner')" id="userScannerBtn">üì± QR Scanner</button>
            <button onclick="showSection('qrgenerator')" id="userQrGeneratorBtn">üîß QR Generator</button>
        </div>

        <!-- QR Scanner Section -->
        <div id="scannerSection" class="form-section hidden">
            <h2>üì± QR Code Scanner</h2>
            
            <div class="workflow-info">
                <h4>üìã Document Workflow:</h4>
                <p><strong>1.</strong> Scan QR code to receive a document</p>
                <p><strong>2.</strong> Update status (Received ‚Üí Processing ‚Üí Forward/Complete)</p>
                <p><strong>3.</strong> Forward to next department or mark as completed</p>
            </div>
            
            <div class="qr-scanner-section">
                <h3>üîç Scan QR Code</h3>
                <p>Enter or paste the tracking ID from the QR code:</p>
                <input type="text" id="scanInput" class="scan-input" placeholder="Enter Tracking ID (e.g., AD-2025-001)" onkeyup="handleScanInput(event)">
                <br>
                <button onclick="processScannedCode()" style="background-color: #27ae60;">üì• Process Document</button>
            </div>
            
            <div id="scannedDocument" class="hidden">
                <!-- Scanned document details will appear here -->
            </div>
        </div>

        <!-- Standalone QR Generator Section -->
        <div id="qrGeneratorSection" class="form-section hidden">
            <h2>üîß QR Code Generator</h2>
            
            <div class="qr-generator-section">
                <h3>üì± Generate QR Code</h3>
                <p>Create QR codes for any text, URL, or tracking ID:</p>
                
                <div class="form-group">
                    <label for="qrText">Text to encode:</label>
                    <input type="text" id="qrText" placeholder="Enter tracking ID, URL, or any text" maxlength="200">
                </div>
                
                <div class="form-group">
                    <label for="qrSize">QR Code Size:</label>
                    <select id="qrSize">
                        <option value="150">Small (150x150)</option>
                        <option value="200" selected>Medium (200x200)</option>
                        <option value="300">Large (300x300)</option>
                    </select>
                </div>
                
                <button onclick="generateStandaloneQR()" style="background-color: #2196f3;">üîß Generate QR Code</button>
                <button onclick="clearQRGenerator()" style="background-color: #6c757d;">üóëÔ∏è Clear</button>
            </div>
            
            <div id="standaloneQRResult" class="qr-result hidden">
                <!-- Generated QR code will appear here -->
            </div>
        </div>

        <div class="form-section" id="documentFormSection">
            <h2>üìù Submit New Document</h2>
            <form id="documentForm">
                <div class="form-group">
                    <label for="documentTitle">Document Title:</label>
                    <input type="text" id="documentTitle" required>
                </div>
                
                <div class="form-group">
                    <label for="documentType">Document Type:</label>
                    <select id="documentType" required>
                        <option value="">Select Document Type</option>
                        <option value="ACTIVITY DESIGN">üìã ACTIVITY DESIGN</option>
                        <option value="PURCHASE REQUEST">üõí PURCHASE REQUEST</option>
                        <option value="BAC RECOMMENDATION AND RESOLUTION">‚öñÔ∏è BAC RECOMMENDATION AND RESOLUTION</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="fromDepartment">From Department:</label>
                    <select id="fromDepartment" required>
                        <option value="">Select Department</option>
                        <option value="Mayor's Office">Mayor's Office</option>
                        <option value="Budget Office">Budget Office</option>
                        <option value="Accounting Office">Accounting Office</option>
                        <option value="Municipal Admin Receiving">Municipal Admin Receiving</option>
                        <option value="Municipal Admin Internal">Municipal Admin Internal</option>
                        <option value="BAC">BAC</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="toDepartment">To Department:</label>
                    <select id="toDepartment" required>
                        <option value="">Select Department</option>
                        <option value="Mayor's Office">Mayor's Office</option>
                        <option value="Budget Office">Budget Office</option>
                        <option value="Accounting Office">Accounting Office</option>
                        <option value="Municipal Admin Receiving">Municipal Admin Receiving</option>
                        <option value="Municipal Admin Internal">Municipal Admin Internal</option>
                        <option value="BAC">BAC</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="documentFile">Upload Document (Soft Copy):</label>
                    <input type="file" id="documentFile" accept=".pdf,.doc,.docx,.jpg,.png">
                </div>
                
                <div class="form-group">
                    <label for="description">Description/Notes:</label>
                    <textarea id="description" rows="3"></textarea>
                </div>
                
                <button type="submit">üì§ Submit Document</button>
            </form>
            
            <div class="qr-section">
                <div id="qrcode"></div>
            </div>
        </div>

        <!-- User Management Section (Admin Only) -->
        <div id="userManagementSection" class="form-section hidden">
            <h2>üë• User Management</h2>
            
            <div style="margin-bottom: 20px;">
                <h3>‚ûï Add New User</h3>
                <form id="addUserForm">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="newUsername">Username:</label>
                            <input type="text" id="newUsername" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="newPassword">Password:</label>
                            <input type="text" id="newPassword" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="newUserDepartment">Department:</label>
                            <select id="newUserDepartment" required>
                                <option value="">Select Department</option>
                                <option value="Mayor's Office">Mayor's Office</option>
                                <option value="Budget Office">Budget Office</option>
                                <option value="Accounting Office">Accounting Office</option>
                                <option value="Municipal Admin Receiving">Municipal Admin Receiving</option>
                                <option value="Municipal Admin Internal">Municipal Admin Internal</option>
                                <option value="BAC">BAC</option>
                                <option value="All Departments">All Departments (Admin)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="newUserName">Full Name:</label>
                            <input type="text" id="newUserName" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="newUserRole">Role:</label>
                        <select id="newUserRole" required>
                            <option value="user">Regular User</option>
                            <option value="admin">Administrator</option>
                        </select>
                    </div>
                    
                    <button type="submit">‚ûï Add User</button>
                </form>
            </div>
            
            <div>
                <h3>üìù Current Users</h3>
                <div id="usersList">
                    <!-- Users will be loaded here -->
                </div>
            </div>
        </div>

        <div class="document-list">
            <h2>üìã Document Tracking</h2>
            
            <!-- Search Section -->
            <div class="search-section">
                <label for="documentSearch">üîç Search Documents:</label>
                <input 
                    type="text" 
                    id="documentSearch" 
                    class="search-box" 
                    placeholder="Search by tracking ID, title, department, or status..." 
                    onkeyup="searchDocuments()"
                >
                <div id="searchResults" class="search-results-info"></div>
            </div>
            
            <div id="documentsList">
                <!-- Documents will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Hidden QR Print Section -->
    <div id="qrPrintSection" class="qr-print-section" style="display: none;">
        <div class="qr-print-title">Document Tracking</div>
        <canvas id="qrPrintCanvas" class="qr-print-canvas"></canvas>
        <div id="qrPrintId" class="qr-print-id"></div>
        <div class="qr-print-info">
            <div>Local Government</div>
            <div>Document Tracking System</div>
            <div id="qrPrintDate"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js"></script>
    <script>
        // Default users (will be saved to localStorage on first run)
        const defaultUsers = {
            'MYO': { password: '123', department: "Mayor's Office", role: 'user', name: "Mayor's Office User" },
            'MBO': { password: '123', department: 'Budget Office', role: 'user', name: 'Budget Office User' },
            'MACO': { password: '123', department: 'Accounting Office', role: 'user', name: 'Accounting Office User' },
            'MADO': { password: '123', department: 'Municipal Admin Receiving', role: 'user', name: 'Municipal Admin User' },
            'admin': { password: 'admin123', department: 'All Departments', role: 'admin', name: 'System Administrator' }
        };

        let users = {};
        let currentUser = null;
        let documentCounter = 1;
        let documents = [];
        let filteredDocuments = [];

        // Check if user is already logged in when page loads
        window.addEventListener('load', function() {
            loadUsers();
            loadDocuments();
            setupEventListeners();
            
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showMainApp();
            }
        });

        function setupEventListeners() {
            // Login form handler
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                
                if (users[username] && users[username].password === password) {
                    currentUser = {
                        username: username,
                        ...users[username]
                    };
                    
                    // Save login status
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    showMainApp();
                    document.getElementById('loginForm').reset();
                } else {
                    alert('‚ùå Invalid username or password!');
                }
            });

            // Document form handler
            document.getElementById('documentForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                console.log('Document form submitted!'); // Debug log
                
                // Get form data
                const title = document.getElementById('documentTitle').value;
                const documentType = document.getElementById('documentType').value;
                const fromDept = document.getElementById('fromDepartment').value;
                const toDept = document.getElementById('toDepartment').value;
                const description = document.getElementById('description').value;
                const file = document.getElementById('documentFile').files[0];
                
                console.log('Form data:', { title, documentType, fromDept, toDept }); // Debug log
                
                // Validate required fields
                if (!title || !documentType || !fromDept || !toDept) {
                    alert('‚ùå Please fill in all required fields!');
                    return;
                }
                
                // Validate department permissions
                if (currentUser.role !== 'admin' && fromDept !== currentUser.department) {
                    alert('‚ùå You can only submit documents from your own department!');
                    return;
                }
                
                if (fromDept === toDept) {
                    alert('‚ùå From and To departments cannot be the same!');
                    return;
                }
                
                // Generate tracking ID based on document type
                let prefix = 'DOC';
                if (documentType === 'ACTIVITY DESIGN') prefix = 'AD';
                else if (documentType === 'PURCHASE REQUEST') prefix = 'PR';
                else if (documentType === 'BAC RECOMMENDATION AND RESOLUTION') prefix = 'BAC';
                
                const trackingId = `${prefix}-2025-${String(documentCounter).padStart(3, '0')}`;
                
                // Create document object
                const newDocument = {
                    id: trackingId,
                    title: title,
                    type: documentType,
                    from: fromDept,
                    to: toDept,
                    description: description,
                    fileName: file ? file.name : 'No file attached',
                    status: 'pending',
                    submittedBy: currentUser.name,
                    submittedByUser: currentUser.username,
                    date: new Date().toLocaleDateString(),
                    time: new Date().toLocaleTimeString(),
                    statusHistory: [{
                        status: 'pending',
                        updatedBy: currentUser.name,
                        department: currentUser.department,
                        timestamp: new Date().toLocaleString()
                    }]
                };
                
                // Add to documents array
                documents.push(newDocument);
                
                // Save to localStorage
                saveDocuments();
                
                // Generate QR Code
                generateQRCode(trackingId, title, documentType);
                
                // Update document list
                updateDocumentsList();
                
                // Clear form
                this.reset();
                if (currentUser.role !== 'admin') {
                    document.getElementById('fromDepartment').value = currentUser.department;
                }
                
                // Increment counter
                documentCounter++;
                
                alert(`‚úÖ Document submitted successfully!\nTracking ID: ${trackingId}\nType: ${documentType}\n\nüì± The receiving department can scan the QR code to process this document.`);
            });

            // Add User Form Handler
            document.getElementById('addUserForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const username = document.getElementById('newUsername').value.trim();
                const password = document.getElementById('newPassword').value;
                const department = document.getElementById('newUserDepartment').value;
                const name = document.getElementById('newUserName').value.trim();
                const role = document.getElementById('newUserRole').value;
                
                // Check if username already exists
                if (users[username]) {
                    alert('‚ùå Username already exists! Please choose a different username.');
                    return;
                }
                
                // Add new user
                users[username] = {
                    password: password,
                    department: department,
                    role: role,
                    name: name
                };
                
                saveUsers();
                this.reset();
                updateUsersList();
                
                alert(`‚úÖ User "${username}" added successfully!`);
            });
        }

        // Search function
        function searchDocuments() {
            const searchTerm = document.getElementById('documentSearch').value.toLowerCase().trim();
            const searchResults = document.getElementById('searchResults');
            
            if (searchTerm === '') {
                filteredDocuments = getVisibleDocuments();
                searchResults.textContent = '';
            } else {
                filteredDocuments = getVisibleDocuments().filter(doc => 
                    doc.id.toLowerCase().includes(searchTerm) ||
                    doc.title.toLowerCase().includes(searchTerm) ||
                    doc.type.toLowerCase().includes(searchTerm) ||
                    doc.from.toLowerCase().includes(searchTerm) ||
                    doc.to.toLowerCase().includes(searchTerm) ||
                    doc.status.toLowerCase().includes(searchTerm) ||
                    doc.submittedBy.toLowerCase().includes(searchTerm) ||
                    (doc.description && doc.description.toLowerCase().includes(searchTerm))
                );
                
                searchResults.textContent = `Found ${filteredDocuments.length} document(s) matching "${searchTerm}"`;
            }
            
            displayDocuments(filteredDocuments);
        }

        function getVisibleDocuments() {
            if (currentUser.role !== 'admin') {
                // Regular users can only see documents from or to their department
                return documents.filter(doc => 
                    doc.from === currentUser.department || 
                    doc.to === currentUser.department ||
                    (doc.statusHistory && doc.statusHistory.some(h => h.department === currentUser.department))
                );
            }
            return documents;
        }

        function displayDocuments(docList) {
            const listDiv = document.getElementById('documentsList');
            
            if (docList.length === 0) {
                const searchTerm = document.getElementById('documentSearch').value.trim();
                const message = searchTerm ? 'No documents found matching your search.' : 'No documents found for your department.';
                listDiv.innerHTML = `<p>${message}</p>`;
                return;
            }
            
            listDiv.innerHTML = docList.map(doc => {
                // Get document type styling
                let typeClass = '';
                let typeIcon = 'üìÑ';
                if (doc.type === 'ACTIVITY DESIGN') { typeClass = 'activity'; typeIcon = 'üìã'; }
                else if (doc.type === 'PURCHASE REQUEST') { typeClass = 'purchase'; typeIcon = 'üõí'; }
                else if (doc.type === 'BAC RECOMMENDATION AND RESOLUTION') { typeClass = 'bac'; typeIcon = '‚öñÔ∏è'; }
                
                return `
                <div class="document-item">
                    <h3>${doc.title}</h3>
                    <div style="margin-bottom: 10px;">
                        <span class="document-type ${typeClass}">${typeIcon} ${doc.type || 'Not specified'}</span>
                    </div>
                    <p><strong>From:</strong> ${doc.from} ‚Üí <strong>To:</strong> ${doc.to}</p>
                    <p><strong>Submitted by:</strong> ${doc.submittedBy}</p>
                    <p><strong>Submitted:</strong> ${doc.date} at ${doc.time}</p>
                    <p><strong>Tracking ID:</strong> ${doc.id}</p>
                    <p><strong>File:</strong> ${doc.fileName}</p>
                    <p><strong>Description:</strong> ${doc.description || 'No description'}</p>
                    ${doc.lastUpdatedBy ? `<p><strong>Last Updated:</strong> ${doc.lastUpdated} by ${doc.lastUpdatedBy}</p>` : ''}
                    <span class="status ${doc.status}">${doc.status.toUpperCase()}</span>
                    ${doc.statusHistory && doc.statusHistory.length > 1 ? `<button onclick="showStatusHistory('${doc.id}')" style="margin-left: 10px; background-color: #9b59b6; font-size: 12px; padding: 8px 12px;">üìä History</button>` : ''}
                    <button onclick="generateQRCode('${doc.id}', '${doc.title.replace(/'/g, "\\'")}', '${doc.type}')" style="margin-left: 10px; background-color: #17a2b8; font-size: 12px; padding: 8px 12px;">üì± Show QR</button>
                </div>
            `;
            }).join('');
        }

        function loadUsers() {
            const savedUsers = localStorage.getItem('users');
            if (savedUsers) {
                users = JSON.parse(savedUsers);
            } else {
                // First time - use default users
                users = { ...defaultUsers };
                saveUsers();
            }
        }

        function saveUsers() {
            localStorage.setItem('users', JSON.stringify(users));
        }

        function showMainApp() {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            // Update welcome message
            document.getElementById('welcomeMessage').textContent = 
                `Welcome, ${currentUser.name} (${currentUser.department})`;
            
            // Show appropriate navigation
            if (currentUser.role === 'admin') {
                document.getElementById('adminNav').classList.remove('hidden');
            } else {
                document.getElementById('userNav').classList.remove('hidden');
            }
            
            // Set user permissions
            setUserPermissions();
            
            // Show documents section by default
            showSection('documents');
        }

        function showSection(section) {
            // Hide all sections
            document.getElementById('documentFormSection').classList.add('hidden');
            document.getElementById('scannerSection').classList.add('hidden');
            document.getElementById('qrGeneratorSection').classList.add('hidden');
            document.getElementById('userManagementSection').classList.add('hidden');
            
            // Remove active class from all buttons
            const navButtons = document.querySelectorAll('.admin-nav button');
            navButtons.forEach(btn => btn.classList.remove('active'));
            
            if (section === 'documents') {
                document.getElementById('documentFormSection').classList.remove('hidden');
                document.getElementById('documentsBtn')?.classList.add('active');
                document.getElementById('userDocumentsBtn')?.classList.add('active');
                updateDocumentsList();
            } else if (section === 'scanner') {
                document.getElementById('scannerSection').classList.remove('hidden');
                document.getElementById('scannerBtn')?.classList.add('active');
                document.getElementById('userScannerBtn')?.classList.add('active');
            } else if (section === 'qrgenerator') {
                document.getElementById('qrGeneratorSection').classList.remove('hidden');
                document.getElementById('qrGeneratorBtn')?.classList.add('active');
                document.getElementById('userQrGeneratorBtn')?.classList.add('active');
            } else if (section === 'users' && currentUser.role === 'admin') {
                document.getElementById('userManagementSection').classList.remove('hidden');
                document.getElementById('usersBtn')?.classList.add('active');
                updateUsersList();
            }
        }

        function setUserPermissions() {
            const fromDept = document.getElementById('fromDepartment');
            const permissionNote = document.getElementById('permissionNote');
            const permissionText = document.getElementById('permissionText');
            
            if (currentUser.role === 'admin') {
                // Admin can see and do everything
                permissionText.textContent = 'You have administrator access. You can submit documents from any department, scan QR codes, and manage users.';
                permissionNote.classList.remove('hidden');
            } else {
                // Regular users can only submit from their department
                permissionText.textContent = `You can submit documents from ${currentUser.department}, scan QR codes to receive documents, and view documents sent to or from your department.`;
                permissionNote.classList.remove('hidden');
                
                // Pre-select user's department and disable the field
                fromDept.value = currentUser.department;
                fromDept.disabled = true;
            }
        }

        // QR Scanner Functions
        function handleScanInput(event) {
            if (event.key === 'Enter') {
                processScannedCode();
            }
        }

        function processScannedCode() {
            const trackingId = document.getElementById('scanInput').value.trim().toUpperCase();
            
            if (!trackingId) {
                alert('‚ùå Please enter a tracking ID!');
                return;
            }
            
            // Find the document
            const doc = documents.find(d => d.id === trackingId);
            
            if (!doc) {
                alert(`‚ùå Document with tracking ID "${trackingId}" not found!`);
                return;
            }
            
            // Check if this department should receive this document
            if (currentUser.role !== 'admin' && doc.to !== currentUser.department) {
                alert(`‚ùå This document is not addressed to your department!\nThis document is for: ${doc.to}`);
                return;
            }
            
            // Show document details and actions
            showScannedDocument(doc);
        }

        function showScannedDocument(doc) {
            const scannedDiv = document.getElementById('scannedDocument');
            
            // Get document type styling
            let typeClass = '';
            let typeIcon = 'üìÑ';
            if (doc.type === 'ACTIVITY DESIGN') { typeClass = 'activity'; typeIcon = 'üìã'; }
            else if (doc.type === 'PURCHASE REQUEST') { typeClass = 'purchase'; typeIcon = 'üõí'; }
            else if (doc.type === 'BAC RECOMMENDATION AND RESOLUTION') { typeClass = 'bac'; typeIcon = '‚öñÔ∏è'; }
            
            scannedDiv.innerHTML = `
                <div class="form-section" style="background-color: #e8f6f3; border-left: 4px solid #27ae60;">
                    <h3>üìÑ Scanned Document</h3>
                    <div class="document-item">
                        <h4>${doc.title}</h4>
                        <div style="margin-bottom: 10px;">
                            <span class="document-type ${typeClass}">${typeIcon} ${doc.type || 'Not specified'}</span>
                        </div>
                        <p><strong>From:</strong> ${doc.from} ‚Üí <strong>To:</strong> ${doc.to}</p>
                        <p><strong>Submitted by:</strong> ${doc.submittedBy}</p>
                        <p><strong>Tracking ID:</strong> ${doc.id}</p>
                        <p><strong>Current Status:</strong> <span class="status ${doc.status}">${doc.status.toUpperCase()}</span></p>
                        <p><strong>Description:</strong> ${doc.description || 'No description'}</p>
                        
                        <div class="action-buttons">
                            <button onclick="updateDocumentStatus('${doc.id}', 'received')" style="background-color: #8e44ad;">
                                üì• Mark as Received
                            </button>
                            <button onclick="updateDocumentStatus('${doc.id}', 'processing')" style="background-color: #3498db;">
                                ‚öôÔ∏è Start Processing
                            </button>
                            <button onclick="showForwardDialog('${doc.id}')" style="background-color: #16a085;">
                                üì§ Forward Document
                            </button>
                            <button onclick="updateDocumentStatus('${doc.id}', 'completed')" style="background-color: #27ae60;">
                                ‚úÖ Mark Complete
                            </button>
                            <button onclick="updateDocumentStatus('${doc.id}', 'returned')" style="background-color: #e74c3c;">
                                üîÑ Return to Sender
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            scannedDiv.classList.remove('hidden');
        }

        function updateDocumentStatus(trackingId, newStatus) {
            const doc = documents.find(d => d.id === trackingId);
            if (!doc) return;
            
            const statusNames = {
                'received': 'Received',
                'processing': 'Processing', 
                'completed': 'Completed',
                'returned': 'Returned to Sender',
                'forwarded': 'Forwarded'
            };
            
            // Add status history
            if (!doc.statusHistory) doc.statusHistory = [];
            doc.statusHistory.push({
                status: newStatus,
                updatedBy: currentUser.name,
                department: currentUser.department,
                timestamp: new Date().toLocaleString()
            });
            
            doc.status = newStatus;
            doc.lastUpdatedBy = currentUser.name;
            doc.lastUpdated = new Date().toLocaleString();
            
            saveDocuments();
            alert(`‚úÖ Document status updated to: ${statusNames[newStatus]}`);
            
            // Clear scanner
            document.getElementById('scanInput').value = '';
            document.getElementById('scannedDocument').classList.add('hidden');
            
            // Refresh document list if visible
            updateDocumentsList();
        }

        function showForwardDialog(trackingId) {
            const doc = documents.find(d => d.id === trackingId);
            if (!doc) return;
            
            const departments = [
                "Mayor's Office",
                "Budget Office", 
                "Accounting Office",
                "Municipal Admin Receiving",
                "Municipal Admin Internal",
                "BAC"
            ];
            
            const availableDepts = departments.filter(dept => 
                dept !== currentUser.department && dept !== doc.from
            );
            
            const deptList = availableDepts.map((dept, index) => 
                `${index + 1}. ${dept}`
            ).join('\n');
            
            const selection = prompt(
                `Forward document "${doc.title}" to which department?\n\n${deptList}\n\nEnter number (1-${availableDepts.length}):`
            );
            
            if (selection && selection >= 1 && selection <= availableDepts.length) {
                const targetDept = availableDepts[selection - 1];
                forwardDocument(trackingId, targetDept);
            }
        }

        function forwardDocument(trackingId, targetDepartment) {
            const doc = documents.find(d => d.id === trackingId);
            if (!doc) return;
            
            // Update document routing
            doc.from = currentUser.department;
            doc.to = targetDepartment;
            doc.status = 'forwarded';
            doc.forwardedBy = currentUser.name;
            doc.forwardedAt = new Date().toLocaleString();
            
            // Add to status history
            if (!doc.statusHistory) doc.statusHistory = [];
            doc.statusHistory.push({
                status: 'forwarded',
                updatedBy: currentUser.name,
                department: currentUser.department,
                forwardedTo: targetDepartment,
                timestamp: new Date().toLocaleString()
            });
            
            saveDocuments();
            alert(`‚úÖ Document forwarded to ${targetDepartment}`);
            
            // Clear scanner
            document.getElementById('scanInput').value = '';
            document.getElementById('scannedDocument').classList.add('hidden');
            
            updateDocumentsList();
        }

        function updateUsersList() {
            const listDiv = document.getElementById('usersList');
            
            const userEntries = Object.entries(users);
            
            if (userEntries.length === 0) {
                listDiv.innerHTML = '<p>No users found.</p>';
                return;
            }
            
            listDiv.innerHTML = userEntries.map(([username, user]) => `
                <div class="user-item">
                    <div class="user-details">
                        <h4>üë§ ${user.name}</h4>
                        <p><strong>Username:</strong> ${username}</p>
                        <p><strong>Department:</strong> ${user.department}</p>
                        <p><strong>Role:</strong> ${user.role === 'admin' ? 'üîë Administrator' : 'üë• Regular User'}</p>
                    </div>
                    <div class="user-actions">
                        <button class="edit-btn" onclick="editUser('${username}')">‚úèÔ∏è Edit</button>
                        ${username !== 'admin' ? `<button class="delete-btn" onclick="deleteUser('${username}')">üóëÔ∏è Delete</button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function editUser(username) {
            const user = users[username];
            
            const newPassword = prompt(`Edit password for ${user.name}:\n\nCurrent password: ${user.password}`, user.password);
            if (newPassword !== null && newPassword.trim() !== '') {
                users[username].password = newPassword.trim();
                saveUsers();
                updateUsersList();
                alert(`‚úÖ Password updated for ${user.name}!`);
            }
        }

        function deleteUser(username) {
            const user = users[username];
            
            if (username === currentUser.username) {
                alert('‚ùå You cannot delete your own account while logged in!');
                return;
            }
            
            if (confirm(`‚ö†Ô∏è Are you sure you want to delete user "${user.name}" (${username})?\n\nThis action cannot be undone!`)) {
                delete users[username];
                saveUsers();
                updateUsersList();
                alert(`‚úÖ User "${user.name}" deleted successfully!`);
            }
        }

        function logout() {
            localStorage.removeItem('currentUser');
            currentUser = null;
            
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('adminNav').classList.add('hidden');
            document.getElementById('userNav').classList.add('hidden');
            
            // Reset form restrictions
            document.getElementById('fromDepartment').disabled = false;
        }

        // Enhanced QR Code Generation with Print Functionality
        function generateQRCode(trackingId, title, documentType) {
            const qrCodeDiv = document.getElementById('qrcode');
            qrCodeDiv.innerHTML = ''; // Clear previous QR code
            
            // Check if QRCode library is loaded
            if (typeof QRCode === 'undefined') {
                console.error('QRCode library not loaded');
                // Fallback if QR library isn't loaded
                qrCodeDiv.innerHTML = `
                    <div class="qr-container">
                        <h4 style="margin: 0 0 10px 0; color: #2c3e50;">üì± QR Code</h4>
                        <p style="font-family: monospace; font-size: 18px; font-weight: bold; color: #2c3e50; margin: 10px 0; text-align: center;">${trackingId}</p>
                        <p style="font-size: 12px; color: #666; margin: 10px 0;">QR library not loaded - use tracking ID above</p>
                    </div>
                `;
                qrCodeDiv.style.display = 'block';
                return;
            }
            
            // Create container for QR code
            const container = document.createElement('div');
            container.className = 'qr-container';
            
            const title_elem = document.createElement('h4');
            title_elem.textContent = 'üì± QR Code Generated';
            title_elem.style.margin = '0 0 15px 0';
            title_elem.style.color = '#2c3e50';
            container.appendChild(title_elem);
            
            // Create canvas for QR code
            const canvas = document.createElement('canvas');
            canvas.id = 'qrCanvas';
            container.appendChild(canvas);
            
            // Generate QR code
            try {
                QRCode.toCanvas(canvas, trackingId, {
                    width: 200,
                    height: 200,
                    margin: 2,
                    colorDark: '#2c3e50',
                    colorLight: '#ffffff',
                    errorCorrectionLevel: 'M'
                }, function (error) {
                    if (error) {
                        console.error('QR Code generation error:', error);
                        container.innerHTML = `
                            <div class="qr-container">
                                <h4>üì± Tracking ID</h4>
                                <p style="font-family: monospace; font-size: 18px; font-weight: bold;">${trackingId}</p>
                                <p style="font-size: 12px; color: #666;">QR code generation failed</p>
                            </div>
                        `;
                    } else {
                        // Add tracking ID text
                        const trackingText = document.createElement('p');
                        trackingText.innerHTML = `<strong>Tracking ID:</strong> ${trackingId}`;
                        trackingText.style.margin = '10px 0';
                        trackingText.style.fontFamily = 'monospace';
                        trackingText.style.fontSize = '14px';
                        container.appendChild(trackingText);
                        
                        // Add document info
                        const docInfo = document.createElement('p');
                        docInfo.innerHTML = `<strong>Document:</strong> ${title}<br><strong>Type:</strong> ${documentType}`;
                        docInfo.style.margin = '10px 0';
                        docInfo.style.fontSize = '12px';
                        docInfo.style.color = '#666';
                        container.appendChild(docInfo);
                        
                        // Add buttons
                        const buttonContainer = document.createElement('div');
                        buttonContainer.style.marginTop = '15px';
                        
                        // Download QR Code button
                        const downloadBtn = document.createElement('button');
                        downloadBtn.textContent = 'üì• Download QR';
                        downloadBtn.onclick = function() {
                            const link = document.createElement('a');
                            link.download = `QR-${trackingId}.png`;
                            link.href = canvas.toDataURL();
                            link.click();
                        };
                        buttonContainer.appendChild(downloadBtn);
                        
                        // Print QR Code button
                        const printBtn = document.createElement('button');
                        printBtn.className = 'qr-print-btn';
                        printBtn.textContent = 'üñ®Ô∏è Print QR (57mm)';
                        printBtn.onclick = function() {
                            printQRCode(trackingId, title, documentType, canvas);
                        };
                        buttonContainer.appendChild(printBtn);
                        
                        container.appendChild(buttonContainer);
                        
                        // Add instructions
                        const instructions = document.createElement('div');
                        instructions.innerHTML = `
                            <p style="margin-top: 15px; font-size: 14px; color: #2c3e50; text-align: left;">
                                <strong>üìã Instructions:</strong><br>
                                1. Print or share this QR code<br>
                                2. Receiving department scans the QR code<br>
                                3. They can update status and forward the document
                            </p>
                        `;
                        container.appendChild(instructions);
                    }
                });
            } catch (error) {
                console.error('QR Code library error:', error);
                container.innerHTML = `
                    <div class="qr-container">
                        <h4>üì± Tracking ID</h4>
                        <p style="font-family: monospace; font-size: 18px; font-weight: bold;">${trackingId}</p>
                        <p style="font-size: 12px; color: #666;">QR code generation failed</p>
                    </div>
                `;
            }
            
            qrCodeDiv.appendChild(container);
            qrCodeDiv.style.display = 'block';
        }

        // Standalone QR Generator Functions
        function generateStandaloneQR() {
            const text = document.getElementById('qrText').value.trim();
            const size = parseInt(document.getElementById('qrSize').value);
            const resultDiv = document.getElementById('standaloneQRResult');
            
            if (!text) {
                alert('‚ùå Please enter text to generate QR code!');
                return;
            }
            
            // Clear previous result
            resultDiv.innerHTML = '';
            
            // Create container
            const container = document.createElement('div');
            container.style.textAlign = 'center';
            
            // Create title
            const title = document.createElement('h3');
            title.textContent = 'üì± Generated QR Code';
            title.style.color = '#2c3e50';
            title.style.marginBottom = '15px';
            container.appendChild(title);
            
            // Create canvas
            const canvas = document.createElement('canvas');
            container.appendChild(canvas);
            
            // Check if QRCode library is loaded
            if (typeof QRCode === 'undefined') {
                container.innerHTML = `
                    <h3>‚ùå QR Code Library Not Available</h3>
                    <p>QR code generation requires an internet connection to load the QR library.</p>
                    <p><strong>Text to encode:</strong> ${text}</p>
                `;
                resultDiv.appendChild(container);
                resultDiv.classList.remove('hidden');
                return;
            }
            
            // Generate QR code
            try {
                QRCode.toCanvas(canvas, text, {
                    width: size,
                    height: size,
                    margin: 2,
                    colorDark: '#2c3e50',
                    colorLight: '#ffffff',
                    errorCorrectionLevel: 'M'
                }, function (error) {
                    if (error) {
                        console.error('Standalone QR generation error:', error);
                        container.innerHTML = `
                            <h3>‚ùå QR Code Generation Failed</h3>
                            <p>Error: ${error.message}</p>
                            <p><strong>Text:</strong> ${text}</p>
                        `;
                    } else {
                        // Add text display
                        const textDisplay = document.createElement('p');
                        textDisplay.innerHTML = `<strong>Encoded Text:</strong><br><code style="background-color: #f8f9fa; padding: 5px; border-radius: 3px;">${text}</code>`;
                        textDisplay.style.margin = '15px 0';
                        container.appendChild(textDisplay);
                        
                        // Add buttons
                        const buttonContainer = document.createElement('div');
                        buttonContainer.style.marginTop = '15px';
                        
                        // Download button
                        const downloadBtn = document.createElement('button');
                        downloadBtn.textContent = 'üì• Download PNG';
                        downloadBtn.style.backgroundColor = '#28a745';
                        downloadBtn.onclick = function() {
                            const link = document.createElement('a');
                            link.download = `QR-${text.substring(0, 20).replace(/[^a-zA-Z0-9]/g, '_')}.png`;
                            link.href = canvas.toDataURL();
                            link.click();
                        };
                        buttonContainer.appendChild(downloadBtn);
                        
                        // Print button
                        const printBtn = document.createElement('button');
                        printBtn.textContent = 'üñ®Ô∏è Print (57mm)';
                        printBtn.className = 'qr-print-btn';
                        printBtn.onclick = function() {
                            printStandaloneQR(text, canvas);
                        };
                        buttonContainer.appendChild(printBtn);
                        
                        container.appendChild(buttonContainer);
                    }
                    
                    resultDiv.appendChild(container);
                    resultDiv.classList.remove('hidden');
                });
            } catch (error) {
                console.error('QR generation error:', error);
                container.innerHTML = `
                    <h3>‚ùå QR Code Generation Error</h3>
                    <p>Failed to generate QR code</p>
                    <p><strong>Text:</strong> ${text}</p>
                `;
                resultDiv.appendChild(container);
                resultDiv.classList.remove('hidden');
            }
        }

        function clearQRGenerator() {
            document.getElementById('qrText').value = '';
            document.getElementById('qrSize').value = '200';
            document.getElementById('standaloneQRResult').classList.add('hidden');
            document.getElementById('standaloneQRResult').innerHTML = '';
        }

        // Print QR Code for 57mm paper
        function printQRCode(trackingId, title, documentType, originalCanvas) {
            // Create print canvas with proper dimensions for 57mm paper
            const printCanvas = document.getElementById('qrPrintCanvas');
            const printSection = document.getElementById('qrPrintSection');
            const printId = document.getElementById('qrPrintId');
            const printDate = document.getElementById('qrPrintDate');
            
            // Set print information
            printId.textContent = trackingId;
            printDate.textContent = new Date().toLocaleDateString();
            
            // Generate QR code for print canvas
            try {
                QRCode.toCanvas(printCanvas, trackingId, {
                    width: 150,  // Adjusted for 57mm paper
                    height: 150,
                    margin: 1,
                    colorDark: '#000000',
                    colorLight: '#ffffff',
                    errorCorrectionLevel: 'M'
                }, function (error) {
                    if (error) {
                        console.error('Print QR Code generation error:', error);
                        alert('‚ùå Failed to generate QR code for printing');
                        return;
                    }
                    
                    // Show the print section temporarily and print
                    printSection.style.display = 'block';
                    
                    // Use setTimeout to ensure the canvas is rendered before printing
                    setTimeout(() => {
                        window.print();
                        
                        // Hide the print section after printing
                        setTimeout(() => {
                            printSection.style.display = 'none';
                        }, 100);
                    }, 100);
                });
            } catch (error) {
                console.error('Print QR error:', error);
                alert('‚ùå Failed to prepare QR code for printing');
            }
        }

        function printStandaloneQR(text, originalCanvas) {
            // Create print canvas with proper dimensions for 57mm paper
            const printCanvas = document.getElementById('qrPrintCanvas');
            const printSection = document.getElementById('qrPrintSection');
            const printId = document.getElementById('qrPrintId');
            const printDate = document.getElementById('qrPrintDate');
            
            // Set print information
            printId.textContent = text.length > 30 ? text.substring(0, 30) + '...' : text;
            printDate.textContent = new Date().toLocaleDateString();
            
            // Generate QR code for print canvas
            try {
                QRCode.toCanvas(printCanvas, text, {
                    width: 150,  // Adjusted for 57mm paper
                    height: 150,
                    margin: 1,
                    colorDark: '#000000',
                    colorLight: '#ffffff',
                    errorCorrectionLevel: 'M'
                }, function (error) {
                    if (error) {
                        console.error('Print QR Code generation error:', error);
                        alert('‚ùå Failed to generate QR code for printing');
                        return;
                    }
                    
                    // Show the print section temporarily and print
                    printSection.style.display = 'block';
                    
                    // Use setTimeout to ensure the canvas is rendered before printing
                    setTimeout(() => {
                        window.print();
                        
                        // Hide the print section after printing
                        setTimeout(() => {
                            printSection.style.display = 'none';
                        }, 100);
                    }, 100);
                });
            } catch (error) {
                console.error('Print QR error:', error);
                alert('‚ùå Failed to prepare QR code for printing');
            }
        }

        function updateDocumentsList() {
            // Reset search when updating the list
            document.getElementById('documentSearch').value = '';
            document.getElementById('searchResults').textContent = '';
            
            filteredDocuments = getVisibleDocuments();
            displayDocuments(filteredDocuments);
        }

        function showStatusHistory(trackingId) {
            const doc = documents.find(d => d.id === trackingId);
            if (!doc || !doc.statusHistory) return;
            
            const history = doc.statusHistory.map((entry, index) => 
                `${index + 1}. ${entry.status.toUpperCase()} - ${entry.updatedBy} (${entry.department}) - ${entry.timestamp}${entry.forwardedTo ? ` ‚Üí Forwarded to: ${entry.forwardedTo}` : ''}`
            ).join('\n');
            
            alert(`üìä Status History for ${doc.title}\n\n${history}`);
        }

        function saveDocuments() {
            localStorage.setItem('documents', JSON.stringify(documents));
            localStorage.setItem('documentCounter', documentCounter.toString());
        }

        function loadDocuments() {
            const savedDocuments = localStorage.getItem('documents');
            const savedCounter = localStorage.getItem('documentCounter');
            
            if (savedDocuments) {
                documents = JSON.parse(savedDocuments);
            }
            
            if (savedCounter) {
                documentCounter = parseInt(savedCounter);
            }
        }
    </script>
</body>
</html>
