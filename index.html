<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Tracking System</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .header {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .login-section {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 400px;
            margin: 20px auto;
        }
        
        .form-section {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .user-info {
            background-color: #3498db;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }
        
        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #2c3e50;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: #3498db;
            outline: none;
        }
        
        button {
            background-color: #3498db;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        .logout-btn {
            background-color: #e74c3c;
        }
        
        .logout-btn:hover {
            background-color: #c0392b;
        }
        
        .qr-section {
            text-align: center;
            margin-top: 20px;
        }
        
        #qrcode {
            margin: 20px auto;
            display: none;
        }
        
        .document-list {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .document-item {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        
        .status {
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 20px;
            color: white;
            display: inline-block;
            margin-top: 10px;
        }
        
        .status.pending { background-color: #f39c12; }
        .status.processing { background-color: #3498db; }
        .status.completed { background-color: #27ae60; }
        .status.returned { background-color: #e74c3c; }
        .status.received { background-color: #8e44ad; }
        .status.forwarded { background-color: #16a085; }
        
        .hidden { display: none; }
        
        .credentials-info {
            background-color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 14px;
        }
        
        .credentials-info h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .permission-note {
            background-color: #f8f9fa;
            border-left: 4px solid #3498db;
            padding: 10px;
            margin-bottom: 20px;
        }
        
        .admin-nav {
            background-color: #34495e;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .admin-nav button {
            background-color: #3498db;
            margin: 0 5px;
        }
        
        .admin-nav button.active {
            background-color: #2c3e50;
        }
        
        .user-item {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            background-color: #f9f9f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .user-details h4 {
            margin: 0 0 5px 0;
            color: #2c3e50;
        }
        
        .user-details p {
            margin: 2px 0;
            color: #666;
            font-size: 14px;
        }
        
        .user-actions button {
            margin-left: 5px;
            padding: 8px 12px;
            font-size: 12px;
        }
        
        .delete-btn {
            background-color: #e74c3c;
        }
        
        .delete-btn:hover {
            background-color: #c0392b;
        }
        
        .edit-btn {
            background-color: #f39c12;
        }
        
        .edit-btn:hover {
            background-color: #d68910;
        }
        
        .document-type {
            background-color: #3498db;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            display: inline-block;
            margin-right: 10px;
        }
        
        .document-type.activity { background-color: #9b59b6; }
        .document-type.purchase { background-color: #e67e22; }
        .document-type.bac { background-color: #27ae60; }
        
        .qr-scanner-section {
            background-color: #e8f6f3;
            border: 2px dashed #27ae60;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .scan-input {
            background-color: #f8f9fa;
            border: 2px solid #6c757d;
            padding: 15px;
            font-family: monospace;
            font-size: 16px;
            text-align: center;
            margin: 10px 0;
        }
        
        .workflow-info {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        /* Search Box Styles */
        .search-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #17a2b8;
        }
        
        .search-box {
            width: 100%;
            padding: 12px;
            border: 2px solid #17a2b8;
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box;
        }
        
        .search-box:focus {
            border-color: #138496;
            outline: none;
            box-shadow: 0 0 5px rgba(23, 162, 184, 0.3);
        }
        
        .search-results-info {
            margin-top: 10px;
            font-size: 14px;
            color: #6c757d;
        }
        
        /* QR Code Container Styles */
        .qr-container {
            background-color: white;
            border: 2px solid #2c3e50;
            border-radius: 8px;
            padding: 20px;
            margin: 20px auto;
            max-width: 300px;
            text-align: center;
        }
        
        .qr-fallback {
            border: 3px dashed #3498db;
            background-color: #f8f9fa;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
        }
        
        .tracking-id-display {
            font-family: monospace;
            font-size: 20px;
            font-weight: bold;
            color: #2c3e50;
            margin: 10px 0;
            letter-spacing: 1px;
            background-color: white;
            padding: 10px;
            border-radius: 4px;
            word-break: break-all;
        }
        
        /* Print Styles for 57mm paper */
        @media print {
            body * {
                visibility: hidden;
            }
            
            .print-content, .print-content * {
                visibility: visible;
            }
            
            .print-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 57mm;
                margin: 0;
                padding: 2mm;
                background: white;
            }
            
            .print-header {
                font-size: 10pt;
                font-weight: bold;
                margin-bottom: 2mm;
                text-align: center;
            }
            
            .print-qr {
                display: block;
                margin: 2mm auto;
                width: 40mm !important;
                height: 40mm !important;
            }
            
            .print-text {
                font-family: monospace;
                font-size: 8pt;
                font-weight: bold;
                text-align: center;
                margin: 2mm 0;
                word-break: break-all;
            }
            
            .print-info {
                font-size: 7pt;
                text-align: center;
                margin-top: 2mm;
                line-height: 1.2;
            }
        }
        
        @page {
            size: 57mm auto;
            margin: 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🔐 Local Government Document Tracking System</h1>
        <p>Secure document tracking with QR code workflow</p>
    </div>

    <!-- Login Section -->
    <div id="loginSection" class="login-section">
        <h2>🔑 User Login</h2>
        <form id="loginForm">
            <div class="form-group">
                <label for="username">Username:</label>
                <input type="text" id="username" required>
            </div>
            
            <div class="form-group">
                <label for="password">Password:</label>
                <input type="password" id="password" required>
            </div>
            
            <button type="submit">🚪 Login</button>
        </form>
        
        <div class="credentials-info">
            <h4>Demo Login Credentials:</h4>
            <p><strong>Mayor's Office:</strong> MYO / 123</p>
            <p><strong>Budget Office:</strong> MBO / 123</p>
            <p><strong>Accounting Office:</strong> MACO / 123</p>
            <p><strong>Municipal Admin:</strong> MADO / 123</p>
            <p><strong>Admin:</strong> admin / admin123</p>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="hidden">
        <div class="user-info">
            <span id="welcomeMessage">Welcome!</span>
            <button class="logout-btn" onclick="logout()">🚪 Logout</button>
        </div>
        
        <div id="permissionNote" class="permission-note hidden">
            <strong>📝 Note:</strong> <span id="permissionText"></span>
        </div>
        
        <!-- Admin Navigation -->
        <div id="adminNav" class="admin-nav hidden">
            <button onclick="showSection('documents')" id="documentsBtn" class="active">📋 Documents</button>
            <button onclick="showSection('scanner')" id="scannerBtn">📱 QR Scanner</button>
            <button onclick="showSection('users')" id="usersBtn">👥 Manage Users</button>
        </div>
        
        <!-- Regular User Navigation -->
        <div id="userNav" class="admin-nav hidden">
            <button onclick="showSection('documents')" id="userDocumentsBtn" class="active">📋 Documents</button>
            <button onclick="showSection('scanner')" id="userScannerBtn">📱 QR Scanner</button>
        </div>

        <!-- QR Scanner Section -->
        <div id="scannerSection" class="form-section hidden">
            <h2>📱 QR Code Scanner</h2>
            
            <div class="workflow-info">
                <h4>📋 Document Workflow:</h4>
                <p><strong>1.</strong> Scan QR code to receive a document</p>
                <p><strong>2.</strong> Update status (Received → Processing → Forward/Complete)</p>
                <p><strong>3.</strong> Forward to next department or mark as completed</p>
            </div>
            
            <div class="qr-scanner-section">
                <h3>🔍 Scan QR Code</h3>
                <p>Enter or paste the tracking ID from the QR code:</p>
                <input type="text" id="scanInput" class="scan-input" placeholder="Enter Tracking ID (e.g., AD-2025-001)" onkeyup="handleScanInput(event)">
                <br>
                <button onclick="processScannedCode()" style="background-color: #27ae60;">📥 Process Document</button>
            </div>
            
            <div id="scannedDocument" class="hidden">
                <!-- Scanned document details will appear here -->
            </div>
        </div>

        <!-- Document Form Section -->
        <div class="form-section" id="documentFormSection">
            <h2>📝 Submit New Document</h2>
            <form id="documentForm">
                <div class="form-group">
                    <label for="documentTitle">Document Title:</label>
                    <input type="text" id="documentTitle" required>
                </div>
                
                <div class="form-group">
                    <label for="documentType">Document Type:</label>
                    <select id="documentType" required>
                        <option value="">Select Document Type</option>
                        <option value="ACTIVITY DESIGN">📋 ACTIVITY DESIGN</option>
                        <option value="PURCHASE REQUEST">🛒 PURCHASE REQUEST</option>
                        <option value="BAC RECOMMENDATION AND RESOLUTION">⚖️ BAC RECOMMENDATION AND RESOLUTION</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="fromDepartment">From Department:</label>
                    <select id="fromDepartment" required>
                        <option value="">Select Department</option>
                        <option value="Mayor's Office">Mayor's Office</option>
                        <option value="Budget Office">Budget Office</option>
                        <option value="Accounting Office">Accounting Office</option>
                        <option value="Municipal Admin Receiving">Municipal Admin Receiving</option>
                        <option value="Municipal Admin Internal">Municipal Admin Internal</option>
                        <option value="BAC">BAC</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="toDepartment">To Department:</label>
                    <select id="toDepartment" required>
                        <option value="">Select Department</option>
                        <option value="Mayor's Office">Mayor's Office</option>
                        <option value="Budget Office">Budget Office</option>
                        <option value="Accounting Office">Accounting Office</option>
                        <option value="Municipal Admin Receiving">Municipal Admin Receiving</option>
                        <option value="Municipal Admin Internal">Municipal Admin Internal</option>
                        <option value="BAC">BAC</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="documentFile">Upload Document (Soft Copy):</label>
                    <input type="file" id="documentFile" accept=".pdf,.doc,.docx,.jpg,.png">
                </div>
                
                <div class="form-group">
                    <label for="description">Description/Notes:</label>
                    <textarea id="description" rows="3"></textarea>
                </div>
                
                <button type="submit">📤 Submit Document</button>
            </form>
            
            <div class="qr-section">
                <div id="qrcode"></div>
            </div>
        </div>

        <!-- User Management Section -->
        <div id="userManagementSection" class="form-section hidden">
            <h2>👥 User Management</h2>
            
            <div style="margin-bottom: 20px;">
                <h3>➕ Add New User</h3>
                <form id="addUserForm">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="newUsername">Username:</label>
                            <input type="text" id="newUsername" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="newPassword">Password:</label>
                            <input type="text" id="newPassword" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="newUserDepartment">Department:</label>
                            <select id="newUserDepartment" required>
                                <option value="">Select Department</option>
                                <option value="Mayor's Office">Mayor's Office</option>
                                <option value="Budget Office">Budget Office</option>
                                <option value="Accounting Office">Accounting Office</option>
                                <option value="Municipal Admin Receiving">Municipal Admin Receiving</option>
                                <option value="Municipal Admin Internal">Municipal Admin Internal</option>
                                <option value="BAC">BAC</option>
                                <option value="All Departments">All Departments (Admin)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="newUserName">Full Name:</label>
                            <input type="text" id="newUserName" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="newUserRole">Role:</label>
                        <select id="newUserRole" required>
                            <option value="user">Regular User</option>
                            <option value="admin">Administrator</option>
                        </select>
                    </div>
                    
                    <button type="submit">➕ Add User</button>
                </form>
            </div>
            
            <div>
                <h3>📝 Current Users</h3>
                <div id="usersList">
                    <!-- Users will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Document List -->
        <div class="document-list">
            <h2>📋 Document Tracking</h2>
            
            <!-- Search Section -->
            <div class="search-section">
                <label for="documentSearch">🔍 Search Documents:</label>
                <input 
                    type="text" 
                    id="documentSearch" 
                    class="search-box" 
                    placeholder="Search by tracking ID, title, department, or status..." 
                    oninput="searchDocuments()"
                >
                <div id="searchResults" class="search-results-info"></div>
            </div>
            
            <div id="documentsList">
                <!-- Documents will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Hidden Print Section -->
    <div id="printContent" class="print-content" style="display: none;">
        <div class="print-header">Document Tracking</div>
        <canvas id="printCanvas" class="print-qr"></canvas>
        <div id="printText" class="print-text"></div>
        <div class="print-info">
            <div>Local Government</div>
            <div>Document Tracking System</div>
            <div id="printDate"></div>
        </div>
    </div>

    <!-- QR Code Library with Multiple Fallbacks -->
    <script>
        // Try to load QR library with multiple CDNs
        function loadQRLibrary() {
            const cdns = [
                'https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js',
                'https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js',
                'https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js'
            ];
            
            let currentCDN = 0;
            
            function tryLoadScript() {
                if (currentCDN >= cdns.length) {
                    console.log('All QR CDNs failed, using fallback mode');
                    window.QRLibraryFailed = true;
                    return;
                }
                
                const script = document.createElement('script');
                script.src = cdns[currentCDN];
                script.onload = function() {
                    console.log(`QR library loaded from: ${cdns[currentCDN]}`);
                };
                script.onerror = function() {
                    console.log(`Failed to load from: ${cdns[currentCDN]}`);
                    currentCDN++;
                    tryLoadScript();
                };
                document.head.appendChild(script);
            }
            
            tryLoadScript();
        }
        
        // Load the QR library
        loadQRLibrary();
    </script>

    <script>
        // Application Variables
        const defaultUsers = {
            'MYO': { password: '123', department: "Mayor's Office", role: 'user', name: "Mayor's Office User" },
            'MBO': { password: '123', department: 'Budget Office', role: 'user', name: 'Budget Office User' },
            'MACO': { password: '123', department: 'Accounting Office', role: 'user', name: 'Accounting Office User' },
            'MADO': { password: '123', department: 'Municipal Admin Receiving', role: 'user', name: 'Municipal Admin User' },
            'admin': { password: 'admin123', department: 'All Departments', role: 'admin', name: 'System Administrator' }
        };

        let users = {};
        let currentUser = null;
        let documentCounter = 1;
        let documents = [];
        let filteredDocuments = [];

        // Initialize Application
        window.addEventListener('load', function() {
            loadUsers();
            loadDocuments();
            setupEventListeners();
            
            // Check if user is already logged in
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showMainApp();
            }
        });

        // Event Listeners Setup
        function setupEventListeners() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                
                if (users[username] && users[username].password === password) {
                    currentUser = {
                        username: username,
                        ...users[username]
                    };
                    
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    showMainApp();
                    document.getElementById('loginForm').reset();
                } else {
                    alert('❌ Invalid username or password!');
                }
            });

            // Document form
            document.getElementById('documentForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const title = document.getElementById('documentTitle').value;
                const documentType = document.getElementById('documentType').value;
                const fromDept = document.getElementById('fromDepartment').value;
                const toDept = document.getElementById('toDepartment').value;
                const description = document.getElementById('description').value;
                const file = document.getElementById('documentFile').files[0];
                
                // Validation
                if (!title || !documentType || !fromDept || !toDept) {
                    alert('❌ Please fill in all required fields!');
                    return;
                }
                
                if (currentUser.role !== 'admin' && fromDept !== currentUser.department) {
                    alert('❌ You can only submit documents from your own department!');
                    return;
                }
                
                if (fromDept === toDept) {
                    alert('❌ From and To departments cannot be the same!');
                    return;
                }
                
                // Generate tracking ID
                let prefix = 'DOC';
                if (documentType === 'ACTIVITY DESIGN') prefix = 'AD';
                else if (documentType === 'PURCHASE REQUEST') prefix = 'PR';
                else if (documentType === 'BAC RECOMMENDATION AND RESOLUTION') prefix = 'BAC';
                
                const trackingId = `${prefix}-2025-${String(documentCounter).padStart(3, '0')}`;
                
                // Create document
                const newDocument = {
                    id: trackingId,
                    title: title,
                    type: documentType,
                    from: fromDept,
                    to: toDept,
                    description: description,
                    fileName: file ? file.name : 'No file attached',
                    status: 'pending',
                    submittedBy: currentUser.name,
                    submittedByUser: currentUser.username,
                    date: new Date().toLocaleDateString(),
                    time: new Date().toLocaleTimeString(),
                    statusHistory: [{
                        status: 'pending',
                        updatedBy: currentUser.name,
                        department: currentUser.department,
                        timestamp: new Date().toLocaleString()
                    }]
                };
                
                documents.push(newDocument);
                saveDocuments();
                generateQRCode(trackingId, title, documentType);
                updateDocumentsList();
                
                this.reset();
                if (currentUser.role !== 'admin') {
                    document.getElementById('fromDepartment').value = currentUser.department;
                }
                
                documentCounter++;
                alert(`✅ Document submitted successfully!\nTracking ID: ${trackingId}\nType: ${documentType}`);
            });

            // Add User Form
            document.getElementById('addUserForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const username = document.getElementById('newUsername').value.trim();
                const password = document.getElementById('newPassword').value;
                const department = document.getElementById('newUserDepartment').value;
                const name = document.getElementById('newUserName').value.trim();
                const role = document.getElementById('newUserRole').value;
                
                if (users[username]) {
                    alert('❌ Username already exists!');
                    return;
                }
                
                users[username] = { password, department, role, name };
                saveUsers();
                this.reset();
                updateUsersList();
                alert(`✅ User "${username}" added successfully!`);
            });
        }

        // Search Function
        function searchDocuments() {
            const searchTerm = document.getElementById('documentSearch').value.toLowerCase().trim();
            const searchResults = document.getElementById('searchResults');
            
            if (searchTerm === '') {
                filteredDocuments = getVisibleDocuments();
                searchResults.textContent = '';
            } else {
                filteredDocuments = getVisibleDocuments().filter(doc => 
                    doc.id.toLowerCase().includes(searchTerm) ||
                    doc.title.toLowerCase().includes(searchTerm) ||
                    doc.type.toLowerCase().includes(searchTerm) ||
                    doc.from.toLowerCase().includes(searchTerm) ||
                    doc.to.toLowerCase().includes(searchTerm) ||
                    doc.status.toLowerCase().includes(searchTerm) ||
                    doc.submittedBy.toLowerCase().includes(searchTerm) ||
                    (doc.description && doc.description.toLowerCase().includes(searchTerm))
                );
                
                searchResults.textContent = `Found ${filteredDocuments.length} document(s) matching "${searchTerm}"`;
            }
            
            displayDocuments(filteredDocuments);
        }

        // Get visible documents based on user permissions
        function getVisibleDocuments() {
            if (currentUser.role !== 'admin') {
                return documents.filter(doc => 
                    doc.from === currentUser.department || 
                    doc.to === currentUser.department ||
                    (doc.statusHistory && doc.statusHistory.some(h => h.department === currentUser.department))
                );
            }
            return documents;
        }

        // Display documents
        function displayDocuments(docList) {
            const listDiv = document.getElementById('documentsList');
            
            if (docList.length === 0) {
                const searchTerm = document.getElementById('documentSearch').value.trim();
                const message = searchTerm ? 'No documents found matching your search.' : 'No documents found for your department.';
                listDiv.innerHTML = `<p>${message}</p>`;
                return;
            }
            
            listDiv.innerHTML = docList.map(doc => {
                let typeClass = '';
                let typeIcon = '📄';
                if (doc.type === 'ACTIVITY DESIGN') { typeClass = 'activity'; typeIcon = '📋'; }
                else if (doc.type === 'PURCHASE REQUEST') { typeClass = 'purchase'; typeIcon = '🛒'; }
                else if (doc.type === 'BAC RECOMMENDATION AND RESOLUTION') { typeClass = 'bac'; typeIcon = '⚖️'; }
                
                return `
                <div class="document-item">
                    <h3>${doc.title}</h3>
                    <div style="margin-bottom: 10px;">
                        <span class="document-type ${typeClass}">${typeIcon} ${doc.type || 'Not specified'}</span>
                    </div>
                    <p><strong>From:</strong> ${doc.from} → <strong>To:</strong> ${doc.to}</p>
                    <p><strong>Submitted by:</strong> ${doc.submittedBy}</p>
                    <p><strong>Submitted:</strong> ${doc.date} at ${doc.time}</p>
                    <p><strong>Tracking ID:</strong> ${doc.id}</p>
                    <p><strong>File:</strong> ${doc.fileName}</p>
                    <p><strong>Description:</strong> ${doc.description || 'No description'}</p>
                    ${doc.lastUpdatedBy ? `<p><strong>Last Updated:</strong> ${doc.lastUpdated} by ${doc.lastUpdatedBy}</p>` : ''}
                    <span class="status ${doc.status}">${doc.status.toUpperCase()}</span>
                    ${doc.statusHistory && doc.statusHistory.length > 1 ? `<button onclick="showStatusHistory('${doc.id}')" style="margin-left: 10px; background-color: #9b59b6; font-size: 12px; padding: 8px 12px;">📊 History</button>` : ''}
                    <button onclick="generateQRCode('${doc.id}', '${doc.title.replace(/'/g, "\\'")}', '${doc.type}')" style="margin-left: 10px; background-color: #17a2b8; font-size: 12px; padding: 8px 12px;">📱 Show QR</button>
                </div>
            `;
            }).join('');
        }

        // QR Code Generation with Fallback
        function generateQRCode(trackingId, title, documentType) {
            const qrCodeDiv = document.getElementById('qrcode');
            qrCodeDiv.innerHTML = '';
            
            // Check if QR library is available
            if (typeof QRCode === 'undefined' || window.QRLibraryFailed) {
                showQRFallback(trackingId, title, documentType);
                return;
            }
            
            const container = document.createElement('div');
            container.className = 'qr-container';
            
            const titleElem = document.createElement('h4');
            titleElem.textContent = '📱 QR Code Generated';
            titleElem.style.margin = '0 0 15px 0';
            titleElem.style.color = '#2c3e50';
            container.appendChild(titleElem);
            
            const canvas = document.createElement('canvas');
            container.appendChild(canvas);
            
            QRCode.toCanvas(canvas, trackingId, {
                width: 200,
                height: 200,
                margin: 2,
                colorDark: '#2c3e50',
                colorLight: '#ffffff',
                errorCorrectionLevel: 'M'
            }, function (error) {
                if (error) {
                    console.error('QR generation error:', error);
                    showQRFallback(trackingId, title, documentType);
                    return;
                }
                
                // Add tracking ID
                const trackingText = document.createElement('p');
                trackingText.innerHTML = `<strong>Tracking ID:</strong> ${trackingId}`;
                trackingText.style.margin = '10px 0';
                trackingText.style.fontFamily = 'monospace';
                trackingText.style.fontSize = '14px';
                container.appendChild(trackingText);
                
                // Add document info
                const docInfo = document.createElement('p');
                docInfo.innerHTML = `<strong>Document:</strong> ${title}<br><strong>Type:</strong> ${documentType}`;
                docInfo.style.margin = '10px 0';
                docInfo.style.fontSize = '12px';
                docInfo.style.color = '#666';
                container.appendChild(docInfo);
                
                // Add buttons
                const buttonContainer = document.createElement('div');
                buttonContainer.style.marginTop = '15px';
                
                // Download button
                const downloadBtn = document.createElement('button');
                downloadBtn.textContent = '📥 Download QR';
                downloadBtn.onclick = function() {
                    const link = document.createElement('a');
                    link.download = `QR-${trackingId}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                };
                buttonContainer.appendChild(downloadBtn);
                
                // Print button
                const printBtn = document.createElement('button');
                printBtn.textContent = '🖨️ Print (57mm)';
                printBtn.style.backgroundColor = '#28a745';
                printBtn.onclick = function() {
                    printQRCode(trackingId, canvas);
                };
                buttonContainer.appendChild(printBtn);
                
                container.appendChild(buttonContainer);
                
                // Add instructions
                const instructions = document.createElement('div');
                instructions.innerHTML = `
                    <p style="margin-top: 15px; font-size: 14px; color: #2c3e50; text-align: left;">
                        <strong>📋 Instructions:</strong><br>
                        1. Print or share this QR code<br>
                        2. Receiving department scans the QR code<br>
                        3. They can update status and forward the document
                    </p>
                `;
                container.appendChild(instructions);
                
                qrCodeDiv.appendChild(container);
                qrCodeDiv.style.display = 'block';
            });
        }

        // QR Fallback when library fails
        function showQRFallback(trackingId, title, documentType) {
            const qrCodeDiv = document.getElementById('qrcode');
            
            qrCodeDiv.innerHTML = `
                <div class="qr-container">
                    <h4 style="margin: 0 0 15px 0; color: #2c3e50;">📱 QR Code Alternative</h4>
                    <div class="qr-fallback">
                        <div class="tracking-id-display">${trackingId}</div>
                        <p style="font-size: 14px; color: #666; margin: 15px 0;">Copy this tracking ID for manual entry</p>
                    </div>
                    <div style="margin-top: 20px;">
                        <button onclick="generateOnlineQR('${trackingId}')" style="background-color: #3498db; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px;">
                            🌐 Generate QR Online
                        </button>
                        <button onclick="copyToClipboard('${trackingId}')" style="background-color: #27ae60; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px;">
                            📋 Copy Tracking ID
                        </button>
                        <button onclick="printTextLabel('${trackingId}', '${title}', '${documentType}')" style="background-color: #f39c12; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px;">
                            🖨️ Print Label
                        </button>
                    </div>
                    <p style="font-size: 12px; color: #666; margin-top: 15px;">
                        <strong>Alternatives:</strong> Visit qr-code-generator.com or use your phone's QR generator
                    </p>
                </div>
            `;
            qrCodeDiv.style.display = 'block';
        }

        // Helper Functions
        function generateOnlineQR(text) {
            const encodedText = encodeURIComponent(text);
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodedText}`;
            window.open(qrUrl, '_blank');
        }

        function copyToClipboard(text) {
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(function() {
                    alert(`✅ Copied to clipboard: ${text}`);
                }).catch(function(err) {
                    fallbackCopy(text);
                });
            } else {
                fallbackCopy(text);
            }
        }

        function fallbackCopy(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.top = "0";
            textArea.style.left = "0";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    alert(`✅ Copied to clipboard: ${text}`);
                } else {
                    prompt('📋 Copy this text manually:', text);
                }
            } catch (err) {
                prompt('📋 Copy this text manually:', text);
            }
            
            document.body.removeChild(textArea);
        }

        // Print Functions
        function printQRCode(trackingId, canvas) {
            const printContent = document.getElementById('printContent');
            const printCanvas = document.getElementById('printCanvas');
            const printText = document.getElementById('printText');
            const printDate = document.getElementById('printDate');
            
            // Copy QR code to print canvas
            const ctx = printCanvas.getContext('2d');
            printCanvas.width = 150;
            printCanvas.height = 150;
            ctx.drawImage(canvas, 0, 0, 150, 150);
            
            printText.textContent = trackingId;
            printDate.textContent = new Date().toLocaleDateString();
            
            printContent.style.display = 'block';
            
            setTimeout(() => {
                window.print();
                setTimeout(() => {
                    printContent.style.display = 'none';
                }, 100);
            }, 100);
        }

        function printTextLabel(trackingId, title, documentType) {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Print Label</title>
                    <style>
                        @page { size: 57mm auto; margin: 2mm; }
                        body { font-family: monospace; font-size: 8pt; text-align: center; margin: 0; padding: 2mm; }
                        .header { font-weight: bold; font-size: 9pt; margin-bottom: 2mm; }
                        .tracking-id { font-size: 10pt; font-weight: bold; margin: 3mm 0; border: 1px solid #000; padding: 2mm; }
                        .info { font-size: 7pt; margin: 1mm 0; }
                    </style>
                </head>
                <body>
                    <div class="header">Document Tracking</div>
                    <div class="tracking-id">${trackingId}</div>
                    <div class="info">Title: ${title}</div>
                    <div class="info">Type: ${documentType}</div>
                    <div class="info">Date: ${new Date().toLocaleDateString()}</div>
                    <div class="info">Local Government System</div>
                </body>
                </html>
            `);
            printWindow.document.close();
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 500);
        }

        // User Management
        function loadUsers() {
            const savedUsers = localStorage.getItem('users');
            if (savedUsers) {
                users = JSON.parse(savedUsers);
            } else {
                users = { ...defaultUsers };
                saveUsers();
            }
        }

        function saveUsers() {
            localStorage.setItem('users', JSON.stringify(users));
        }

        function updateUsersList() {
            const listDiv = document.getElementById('usersList');
            const userEntries = Object.entries(users);
            
            if (userEntries.length === 0) {
                listDiv.innerHTML = '<p>No users found.</p>';
                return;
            }
            
            listDiv.innerHTML = userEntries.map(([username, user]) => `
                <div class="user-item">
                    <div class="user-details">
                        <h4>👤 ${user.name}</h4>
                        <p><strong>Username:</strong> ${username}</p>
                        <p><strong>Department:</strong> ${user.department}</p>
                        <p><strong>Role:</strong> ${user.role === 'admin' ? '🔑 Administrator' : '👥 Regular User'}</p>
                    </div>
                    <div class="user-actions">
                        <button class="edit-btn" onclick="editUser('${username}')">✏️ Edit</button>
                        ${username !== 'admin' ? `<button class="delete-btn" onclick="deleteUser('${username}')">🗑️ Delete</button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function editUser(username) {
            const user = users[username];
            const newPassword = prompt(`Edit password for ${user.name}:\n\nCurrent password: ${user.password}`, user.password);
            if (newPassword !== null && newPassword.trim() !== '') {
                users[username].password = newPassword.trim();
                saveUsers();
                updateUsersList();
                alert(`✅ Password updated for ${user.name}!`);
            }
        }

        function deleteUser(username) {
            const user = users[username];
            if (username === currentUser.username) {
                alert('❌ You cannot delete your own account!');
                return;
            }
            
            if (confirm(`⚠️ Delete user "${user.name}" (${username})?\n\nThis cannot be undone!`)) {
                delete users[username];
                saveUsers();
                updateUsersList();
                alert(`✅ User "${user.name}" deleted!`);
            }
        }

        // Scanner Functions
        function handleScanInput(event) {
            if (event.key === 'Enter') {
                processScannedCode();
            }
        }

        function processScannedCode() {
            const trackingId = document.getElementById('scanInput').value.trim().toUpperCase();
            
            if (!trackingId) {
                alert('❌ Please enter a tracking ID!');
                return;
            }
            
            const doc = documents.find(d => d.id === trackingId);
            
            if (!doc) {
                alert(`❌ Document "${trackingId}" not found!`);
                return;
            }
            
            if (currentUser.role !== 'admin' && doc.to !== currentUser.department) {
                alert(`❌ This document is for: ${doc.to}`);
                return;
            }
            
            showScannedDocument(doc);
        }

        function showScannedDocument(doc) {
            const scannedDiv = document.getElementById('scannedDocument');
            
            let typeClass = '';
            let typeIcon = '📄';
            if (doc.type === 'ACTIVITY DESIGN') { typeClass = 'activity'; typeIcon = '📋'; }
            else if (doc.type === 'PURCHASE REQUEST') { typeClass = 'purchase'; typeIcon = '🛒'; }
            else if (doc.type === 'BAC RECOMMENDATION AND RESOLUTION') { typeClass = 'bac'; typeIcon = '⚖️'; }
            
            scannedDiv.innerHTML = `
                <div class="form-section" style="background-color: #e8f6f3; border-left: 4px solid #27ae60;">
                    <h3>📄 Scanned Document</h3>
                    <div class="document-item">
                        <h4>${doc.title}</h4>
                        <div style="margin-bottom: 10px;">
                            <span class="document-type ${typeClass}">${typeIcon} ${doc.type || 'Not specified'}</span>
                        </div>
                        <p><strong>From:</strong> ${doc.from} → <strong>To:</strong> ${doc.to}</p>
                        <p><strong>Submitted by:</strong> ${doc.submittedBy}</p>
                        <p><strong>Tracking ID:</strong> ${doc.id}</p>
                        <p><strong>Current Status:</strong> <span class="status ${doc.status}">${doc.status.toUpperCase()}</span></p>
                        <p><strong>Description:</strong> ${doc.description || 'No description'}</p>
                        
                        <div class="action-buttons">
                            <button onclick="updateDocumentStatus('${doc.id}', 'received')" style="background-color: #8e44ad;">
                                📥 Mark as Received
                            </button>
                            <button onclick="updateDocumentStatus('${doc.id}', 'processing')" style="background-color: #3498db;">
                                ⚙️ Start Processing
                            </button>
                            <button onclick="showForwardDialog('${doc.id}')" style="background-color: #16a085;">
                                📤 Forward Document
                            </button>
                            <button onclick="updateDocumentStatus('${doc.id}', 'completed')" style="background-color: #27ae60;">
                                ✅ Mark Complete
                            </button>
                            <button onclick="updateDocumentStatus('${doc.id}', 'returned')" style="background-color: #e74c3c;">
                                🔄 Return to Sender
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            scannedDiv.classList.remove('hidden');
        }

        function updateDocumentStatus(trackingId, newStatus) {
            const doc = documents.find(d => d.id === trackingId);
            if (!doc) return;
            
            const statusNames = {
                'received': 'Received',
                'processing': 'Processing', 
                'completed': 'Completed',
                'returned': 'Returned to Sender',
                'forwarded': 'Forwarded'
            };
            
            if (!doc.statusHistory) doc.statusHistory = [];
            doc.statusHistory.push({
                status: newStatus,
                updatedBy: currentUser.name,
                department: currentUser.department,
                timestamp: new Date().toLocaleString()
            });
            
            doc.status = newStatus;
            doc.lastUpdatedBy = currentUser.name;
            doc.lastUpdated = new Date().toLocaleString();
            
            saveDocuments();
            alert(`✅ Document status updated to: ${statusNames[newStatus]}`);
            
            document.getElementById('scanInput').value = '';
            document.getElementById('scannedDocument').classList.add('hidden');
            updateDocumentsList();
        }

        function showForwardDialog(trackingId) {
            const doc = documents.find(d => d.id === trackingId);
            if (!doc) return;
            
            const departments = [
                "Mayor's Office", "Budget Office", "Accounting Office",
                "Municipal Admin Receiving", "Municipal Admin Internal", "BAC"
            ];
            
            const availableDepts = departments.filter(dept => 
                dept !== currentUser.department && dept !== doc.from
            );
            
            const deptList = availableDepts.map((dept, index) => 
                `${index + 1}. ${dept}`
            ).join('\n');
            
            const selection = prompt(
                `Forward "${doc.title}" to:\n\n${deptList}\n\nEnter number (1-${availableDepts.length}):`
            );
            
            if (selection && selection >= 1 && selection <= availableDepts.length) {
                const targetDept = availableDepts[selection - 1];
                forwardDocument(trackingId, targetDept);
            }
        }

        function forwardDocument(trackingId, targetDepartment) {
            const doc = documents.find(d => d.id === trackingId);
            if (!doc) return;
            
            doc.from = currentUser.department;
            doc.to = targetDepartment;
            doc.status = 'forwarded';
            doc.forwardedBy = currentUser.name;
            doc.forwardedAt = new Date().toLocaleString();
            
            if (!doc.statusHistory) doc.statusHistory = [];
            doc.statusHistory.push({
                status: 'forwarded',
                updatedBy: currentUser.name,
                department: currentUser.department,
                forwardedTo: targetDepartment,
                timestamp: new Date().toLocaleString()
            });
            
            saveDocuments();
            alert(`✅ Document forwarded to ${targetDepartment}`);
            
            document.getElementById('scanInput').value = '';
            document.getElementById('scannedDocument').classList.add('hidden');
            updateDocumentsList();
        }

        // Application Navigation
        function showMainApp() {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            document.getElementById('welcomeMessage').textContent = 
                `Welcome, ${currentUser.name} (${currentUser.department})`;
            
            if (currentUser.role === 'admin') {
                document.getElementById('adminNav').classList.remove('hidden');
            } else {
                document.getElementById('userNav').classList.remove('hidden');
            }
            
            setUserPermissions();
            showSection('documents');
        }

        function showSection(section) {
            document.getElementById('documentFormSection').classList.add('hidden');
            document.getElementById('scannerSection').classList.add('hidden');
            document.getElementById('userManagementSection').classList.add('hidden');
            
            const navButtons = document.querySelectorAll('.admin-nav button');
            navButtons.forEach(btn => btn.classList.remove('active'));
            
            if (section === 'documents') {
                document.getElementById('documentFormSection').classList.remove('hidden');
                document.getElementById('documentsBtn')?.classList.add('active');
                document.getElementById('userDocumentsBtn')?.classList.add('active');
                updateDocumentsList();
            } else if (section === 'scanner') {
                document.getElementById('scannerSection').classList.remove('hidden');
                document.getElementById('scannerBtn')?.classList.add('active');
                document.getElementById('userScannerBtn')?.classList.add('active');
            } else if (section === 'users' && currentUser.role === 'admin') {
                document.getElementById('userManagementSection').classList.remove('hidden');
                document.getElementById('usersBtn')?.classList.add('active');
                updateUsersList();
            }
        }

        function setUserPermissions() {
            const fromDept = document.getElementById('fromDepartment');
            const permissionNote = document.getElementById('permissionNote');
            const permissionText = document.getElementById('permissionText');
            
            if (currentUser.role === 'admin') {
                permissionText.textContent = 'Administrator access: Submit from any department, scan QR codes, manage users.';
                permissionNote.classList.remove('hidden');
            } else {
                permissionText.textContent = `Submit from ${currentUser.department}, scan QR codes, view department documents.`;
                permissionNote.classList.remove('hidden');
                fromDept.value = currentUser.department;
                fromDept.disabled = true;
            }
        }

        function logout() {
            localStorage.removeItem('currentUser');
            currentUser = null;
            
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('adminNav').classList.add('hidden');
            document.getElementById('userNav').classList.add('hidden');
            
            document.getElementById('fromDepartment').disabled = false;
        }

        // Document Management
        function updateDocumentsList() {
            document.getElementById('documentSearch').value = '';
            document.getElementById('searchResults').textContent = '';
            
            filteredDocuments = getVisibleDocuments();
            displayDocuments(filteredDocuments);
        }

        function showStatusHistory(trackingId) {
            const doc = documents.find(d => d.id === trackingId);
            if (!doc || !doc.statusHistory) return;
            
            const history = doc.statusHistory.map((entry, index) => 
                `${index + 1}. ${entry.status.toUpperCase()} - ${entry.updatedBy} (${entry.department}) - ${entry.timestamp}${entry.forwardedTo ? ` → ${entry.forwardedTo}` : ''}`
            ).join('\n');
            
            alert(`📊 Status History for ${doc.title}\n\n${history}`);
        }

        function saveDocuments() {
            localStorage.setItem('documents', JSON.stringify(documents));
            localStorage.setItem('documentCounter', documentCounter.toString());
        }

        function loadDocuments() {
            const savedDocuments = localStorage.getItem('documents');
            const savedCounter = localStorage.getItem('documentCounter');
            
            if (savedDocuments) {
                documents = JSON.parse(savedDocuments);
            }
            
            if (savedCounter) {
                documentCounter = parseInt(savedCounter);
            }
        }
    </script>
</body>
</html>
